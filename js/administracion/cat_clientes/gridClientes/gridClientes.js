/*
 * File: gridClientes.js
 * Date: Sat Apr 02 2016 09:29:50 GMT-0700 (Hora estándar Montañas (México))
 * 
 * This file was generated by Ext Designer version 1.1.2.
 * http://www.sencha.com/products/designer/
 *
 * This file will be generated the first time you export.
 *
 * You should implement event handling and custom methods in this
 * class.
 */
Ext.ns('miErpWeb');
Ext.ns('mew');
gridClientes = Ext.extend(gridClientesUi, {
	renderRazonSocial:function(a,b,c,d){
        var comercial=c.data.nombre_comercial;
        var fiscal=c.data.nombre_fiscal;
		if (fiscal==undefined){
			fiscal='';
		}
       var div="<table>"+
          "<tr>"+
            "<td style='font-weight:bold;'>"+fiscal+"</td>"+
         "</tr>"+
          "<tr>"+
            "<td>"+comercial+"</td>"+
         "</tr>"+       
          "</table>";

      return div;
    },
	renderContacto:function(a,b,c,d){
		var imgCli="<img style='width:12px;height:12px;' src='images/iconos/clientes.png' />";
        var imgMail="<img style='width:12px;height:12px;' src='images/iconos/mail_chico.png' />";
        var msgNom,msgMail;

        msgNom=c.data.nombre_contacto;
        msgMail=c.data.email_contacto;
        msgMail=msgMail.toLowerCase();
        if (c.data.email_contacto==""){
            msgMail="<p style='font-style:italic'>sin email</p>";
        }            

      var div="<table>"+
           "<tr>"+
           "<td style='width:16px;'>"+imgCli+"</td>"+
            "<td>"+msgNom+"</td>"+
         "</tr>"+
          "<tr>"+
            "<td style='width:16px;'>"+imgMail+"</td>"+
            "<td>"+msgMail+"</td>"+
         "</tr>"+         
          "</table>";

      return div;
	},
	renderTipoCliente:function(a,b,c,d){
		var tipo_cliente='';
		switch(c.data.tipo_cliente){
			case 'F':
				tipo_cliente='FISICA';
			break;
			case 'M':
				tipo_cliente='MORAL';
			break;
			case 'G':
				tipo_cliente='PUBLICO EN GENERAL';
			break;
		}
		
        tipo_cliente=miErpWeb.formatearTexto(tipo_cliente);
        


        // var RFCCliDet=c.data.RFCCliDet;
		// if (RFCCliDet==undefined){
			// RFCCliDet='';
		// }
        var div="<table>"+
        "<tr>"+
            "<td style='font-weight:bold;'>"+tipo_cliente+"</td>"+
            "</tr>"+
        "</table>";
        return div;
	},
	renderTelefonos:function(a,b,c,d){
        var imgCel="<img src='images/iconos/users_grid/smartphone.png' />";
        var imgTel="<img src='images/iconos/users_grid/telephone.png' />";

        var msgTel,msgCel;

        msgTel=c.data.telefono_contacto;
        msgCel=c.data.celular_contacto;
                
        if (c.data.telefono_contacto==""){
          //  imgTel="";
            msgTel="<p style='font-style:italic'>sin teléfono</p>";
        }
        if (c.data.celular_contacto==""){
          //  imgCel="";
            msgCel="<p style='font-style:italic'>sin celular</p>";
        }

      var div="<table>"+
          "<tr>"+
            "<td style='width:16px;'>"+imgTel+"</td>"+
            "<td>"+msgTel+"</td>"+
         "</tr>"+
         "<tr>"+
            "<td style='width:16px;'>"+imgCel+"</td>"+
            "<td>"+msgCel+"</td>"+
         "</tr>"+
          "</table>";

      return div;
    },
	configurarToobar:function(){
		if (this.iconMaster!=undefined){
			this.btnAgregar.setIcon('images/iconos/'+this.iconMaster+'_add.png');
			this.btnEditar.setIcon('images/iconos/'+this.iconMaster+'_edit.png');
			this.btnEliminar.setIcon('images/iconos/'+this.iconMaster+'_delete.png');
			
		}
		
	},
	inicializarStores:function(){
			this.store=new miErpWeb.storeGridClientes();
			this.bottomToolbar.bindStore(this.store);
				
		   
		  
			this.cmbStatus.store = new miErpWeb.storeGridClientesStatus();        
			var data=new Array(
					{id:'A',nombre:miErpWeb.formatearTexto('ACTIVOS')},
					{id:'I',nombre:miErpWeb.formatearTexto('INACTIVOS')},
					{id:'T',nombre:miErpWeb.formatearTexto('TODOS')}
			);
			 this.cmbStatus.store.loadData({data:data});
			 this.cmbStatus.setValue('A');
			 
			 this.bottomToolbar.pageSize=miErpWeb.parametros.registros_pagina;
	},
	inicializarEvents:function(){
			this.store.on('beforeload',function(){
				this.el.mask(mew.mensajeDeEspera);  
				this.store.baseParams=this.store.baseParams || {};
				this.store.baseParams.filtro=this.txtFiltro.getValue();
				this.store.baseParams.filtroStatus=this.cmbStatus.getValue();
			},this);
					
			this.store.on('load',function(){
				this.el.unmask();
			},this);
			
			this.btnAgregar.on('click',function(){
				this.nuevo();
			},this);
			
			this.btnEditar.on('click',function(){
				this.editar();
			},this);
			
			this.btnEliminar.on('click',function(){
				this.eliminar();
			},this);
			
			
			
			this.txtFiltro.on('specialkey',function(comp,e){		
				if (e.getCharCode()==e.ENTER){
					this.bottomToolbar.doRefresh();
				}
			},this);
			
			this.cmbStatus.on('select',function(combo, record, index){	
					this.bottomToolbar.doRefresh();			
			},this);
	},
    configurarRenders:function(){
		var colModel=this.getColumnModel();
        var columna=colModel.getColumnById('colRazonSocial');
        columna.renderer=this.renderRazonSocial
		
		var colModel=this.getColumnModel();
        var columna=colModel.getColumnById('colContacto');
        columna.renderer=this.renderContacto
		
		var colModel=this.getColumnModel();
        var columna=colModel.getColumnById('colTipoCliente');
        columna.renderer=this.renderTipoCliente
		
		var colModel=this.getColumnModel();
        var columna=colModel.getColumnById('colTelefonos');
        columna.renderer=this.renderTelefonos
		
		
	},	
	initComponent: function() {
		this.columnaStatus="status";
        gridClientes.superclass.initComponent.call(this);
		 this.configurarToobar();
		 this.inicializarStores();
		 this.inicializarEvents();
		 this.configurarRenders();
		
	},
	nuevo:function(){
    	var params={            
           xtype:'formClientes',           
           idValue:0,
           title:'Nuevo Cliente',
		   closable: true,
           iconMaster:this.iconMaster ,           
           // icon:"images/iconos/"+this.iconMaster+"_add.png"
       };
    			
       var tab=MainContainer.cargarTab(params);
    },
	editar:function(id){
		if (id==undefined){	//obtener el id del registro seleccionado
    		var  sel=this.getSelectionModel().getSelections();
    		if (sel.length==undefined || sel.length==0){
    			return;
    		}else{
    			id=sel[0].id;    			
    		}
    	}
		
    	var params={            
           xtype:'formClientes',           
           idValue:id,           
           title:'Editar Cliente',
           iconMaster:this.iconMaster,
			closable: true,		   
           icon:"images/iconos/"+this.iconMaster+"_edit.png"
       };
    			
       var tab=MainContainer.cargarTab(params);
       
       tab.on('eliminado',function(id){
    	   var rec=this.store.getById(id);
    	   if (rec==undefined){
    		   return;
    	   }
    	   this.store.remove(rec);
       },this);
    },
	eliminar:function(btn,id){
		switch(btn){	//ESTE SWITCH ES USADO PARA ANALIZAR LO QUE TRATA DE HACER EL USUARIO, LA PRIERA VEZ DEBE ENTRAR A default:
    	case 'no':
    		return;
    	break;
    	case 'yes':
    		this.eliminar('borrar');
    		return;
    		break;
    	case 'borrar':
    		break;		//SALE DEL SWITCH Y SIGUE EJECUTANDOSE LA FUNCI�N
    	case undefined:	//AQUI ENTRA LA PRIMERA VEZ
    	case false:    		
    	default:
    		var me=this;    		
    		Ext.Msg.show({
 			   title:'Confirme por favor',
 			   msg: "¿Desea borrar el Cliente?",
 			   buttons: Ext.Msg.YESNO,
 			   fn: function(btn){	    				
    				me.eliminar(btn);
    			},
 			   scope:this,
 			   icon: Ext.MessageBox.QUESTION
 			});
    		return;
		} 
		
		if (id==undefined){	//obtener el id del registro seleccionado
    		var  sel=this.getSelectionModel().getSelections();
    		if (sel.length==undefined || sel.length==0){
    			return;
    		}else{
    			id=sel[0].id;    			
    		}
    	}
		
		this.el.mask(mfw.mensajeDeEspera);
		Ext.Ajax.request({
			params: { id_cliente: id },
			scope:this,
		   	url: 'app.php/clientes/eliminar',
		   	success: function(response,options){	
				var respuesta=Ext.decode(response.responseText);
				if (respuesta.success==false){
					this.el.unmask();
					return;
				}
				
				this.bottomToolbar.doRefresh();			
				
		   	},
		   	failure: function(){
		   		this.el.unmask();
		   	}		   
		});
	},
	listeners:{
    	activate:function(){
    		if (this.activado==true){
    			return;
    		}
    		this.activado=true;
    		this.bottomToolbar.doRefresh();
    	},
    	rowdblclick : function( grid ,rowIndex, e ){   
    		var rec=this.store.getAt(rowIndex);
    		this.editar(rec.id);
    	},
    	rowclick : function( grid ,rowIndex, e ){
    		var  sel=this.getSelectionModel().getSelections();
    		if (sel.length==undefined || sel.length==0){
    			this.btnEditar.setDisabled(true);
    		}else{
    			this.btnEditar.setDisabled(false);
    		}
			if (sel.length==undefined || sel.length==0){
				this.btnEliminar.setDisabled(true);
			}else{
				this.btnEliminar.setDisabled(false);
			}
    		
    	}
    }
});
Ext.reg('gridClientes', gridClientes);